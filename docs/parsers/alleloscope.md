# Alleloscope Parser

This module provides `AlleloscopeParser`, specialized for parsing **Alleloscope** outputs and exporting standardized matrices and helper files used by hcbench workflows.

Key features:

- Read Alleloscope **RDS** outputs (genotypes and segmentation table) and convert them into a unified haplotype level CNA matrix
- Optional region splitting by a user defined `bin_size`
- Parse Alleloscope cluster assignments into a standardized `clusters.csv`
- Export bin-level count matrices as `bin_counts.csv`
- Convert a cellSNP-like VAF long table into sparse matrix outputs

## üöÄ Quick Example

### Parse the CNA Matrix from RDS

```python
from hcbench.parsers.alleloscope import AlleloscopeParser

allelo_output = "/output/alleloscope/"
genotypes_rds = "/demo_output/alleloscope/genotypes.rds"
seg_table_rds = "/demo_output/alleloscope/seg_table.rds"

alleloscope_parser = AlleloscopeParser(
    output_path=allelo_output,
    genotypes_rds_path=genotypes_rds,
    seg_table_rds_path=seg_table_rds,
    barcode_path=None,
    bin_size=100000,          # set an integer to split regions, e.g. 100000
    start_offset=1,         # shift start coordinate by +1 if needed
)

alleloscope_parser.run()
```

After running, the parser will read the two RDS files and save results to the output directory, typically containing files, for example:

```
/output/alleloscope/
  haplotype_combined.csv
  haplotype_1.csv
  haplotype_2.csv
  minor.csv
  major.csv
  minor_major.csv
```



















































## üìÇ Input Files

The input directory of **Alleloscope** typically contains two `.rds` files and one optional cluster file:

```
demo_output/alleloscope/
‚îú‚îÄ‚îÄ genotypes_all_Sample.rds
‚îú‚îÄ‚îÄ seg_table_all_Sample.rds
‚îî‚îÄ‚îÄ cluster_assignment.csv   # optional
```

- `genotypes_all_Sample.rds` ‚Äî contains the per-cell genotyping matrix.
- `seg_table_all_Sample.rds` ‚Äî contains segmentation information for genomic regions.
- `cluster_assignment.csv` ‚Äî optional file linking cells to inferred clones.

These `.rds` files are generated by the R-based Alleloscope pipeline.
 They must be readable using the Python package **pyreadr**.

------

## üì§ Output Files

After parsing, the following files are generated in the specified output directory:

```
haplotype_combined.csv
clusters.csv          # only if cluster file provided
haplotype_1.csv       # if split_haplotype=True
haplotype_2.csv       # if split_haplotype=True
minor.csv             # if split_haplotype=True
major.csv             # if split_haplotype=True
minor_major.csv       # if split_haplotype=True
```

- `haplotype_combined.csv` ‚Äî the main CNA matrix (regions √ó cells)
   Each value represents the combined haplotype copy number in the form `"hap1|hap2"`.
- `clusters.csv` ‚Äî maps each cell to its corresponding clone ID, if available.

------

## ‚öôÔ∏è Key Parameters

| Parameter            | Description                                        | Default |
| -------------------- | -------------------------------------------------- | ------- |
| `genotypes_rds_path` | Path to `genotypes_all_Sample.rds`.                | ‚Äî       |
| `seg_table_rds_path` | Path to `seg_table_all_Sample.rds`.                | ‚Äî       |
| `output_path`        | Directory to save parsed results.                  | ‚Äî       |
| `bin_size`           | Optional bin size to split large regions.          | `None`  |
| `add_chr_prefix`     | Whether to prepend `"chr"` to chromosome names.    | `True`  |
| `start_plus_one`     | Whether to convert `START` to 1-based coordinates. | `True`  |

When `bin_size` is provided, large segments are automatically subdivided into equal bins.

------

## üöÄ Example Usage

```
from hcbench.parsers.alleloscope import AlleloscopeParser

genotypes_rds = "/demo_output/alleloscope/genotypes_all_Sample.rds"
seg_table_rds = "/demo_output/alleloscope/seg_table_all_Sample.rds"
output_dir = "/output/alleloscope/"

alleloscope_parser = AlleloscopeParser(
    genotypes_rds_path=genotypes_rds,
    seg_table_rds_path=seg_table_rds,
    output_path=output_dir,
    bin_size=100000  # optional
)
alleloscope_parser.run()
```

If you also have a cluster file:

```
cluster_file = "/demo_output/alleloscope/cluster.csv"
alleloscope_parser.get_cluster(cluster_file)
```



## üß¨ Generating a Cluster File in R

If you wish to generate the Alleloscope clustering file from your processed object in R,
 you can use the following commands:

```
linplot = Lineage_plot(Obj_filtered = Obj_filtered, nSNP = 2000, nclust = 10)
write.csv(linplot, file = "cluster.csv", row.names = TRUE)
```

This will create a `cluster.csv` file that can be used as input to `AlleloscopeParser.get_cluster()` in Python.

------
